name: DXF to DWG CI

on:
  push:
    branches: ["development"]
  pull_request:
    branches: ["development"]

jobs:
  test-dxf:
    runs-on: [self-hosted]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t dxf-app .

      - name: Create test DXF
        run: |
          mkdir -p tmp dwg_out
          echo "0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nENDSEC\n0\nSECTION\n2\nBLOCKS\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n0\nLINE\n8\n0\n10\n0\n20\n0\n11\n100\n21\n100\n0\nENDSEC\n0\nSECTION\n2\nOBJECTS\n0\nENDSEC\n0\nEOF" > tmp/test.dxf

      - name: Run conversion inside container
        run: |
          docker run --rm -v ${{ github.workspace }}/tmp:/tmp \
            -v ${{ github.workspace }}/dwg_out:/dwg_out \
            dxf-app \
            bash -c "xvfb-run ./squashfs-root/usr/bin/ODAFileConverter /tmp/test.dxf /dwg_out ACAD2018 DWG 0 1"

      - name: List converted files
        run: ls -la dwg_out